<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FastAPI User Test Client</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        button { padding: 6px 12px; margin-top: 8px; cursor: pointer; }
        input { margin: 5px 0; padding: 6px; width: 200px; }
        pre { background: #f4f4f4; padding: 10px; }
    </style>
</head>
<body>

<h2>FastAPI JWT 测试页面</h2>

<div class="box">
    <h3>登录获取 Token</h3>
    <label>用户名：</label><br>
    <input id="username" type="text" placeholder="username"><br>

    <label>密码：</label><br>
    <input id="password" type="password" placeholder="password"><br>

    <button onclick="login()">登录</button>

    <h4>Token：</h4>
    <pre id="tokenOutput">(无)</pre>
</div>

<div class="box">
    <h3>获取当前用户信息（POST /users/me/get）</h3>
    <button onclick="getMe()">获取我的信息</button>
    <h4>返回结果：</h4>
    <pre id="meOutput">(空)</pre>
</div>

<script>
    let token = null;

    // 登录
    async function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        const formData = new URLSearchParams();
        formData.append("username", username);
        formData.append("password", password);
        formData.append("grant_type", "password");

        try {
            const res = await fetch("http://127.0.0.1:8000/auth/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: formData
            });

            const data = await res.json();

            if (res.ok) {
                token = data.access_token;
                document.getElementById("tokenOutput").innerText = token;
            } else {
                document.getElementById("tokenOutput").innerText = JSON.stringify(data, null, 2);
            }
        } catch (err) {
            alert("登录失败：" + err);
        }
    }

    // 获取当前用户信息
    async function getMe() {
        if (!token) {
            alert("请先登录！");
            return;
        }

        try {
            const res = await fetch("http://127.0.0.1:8000/users/me/get", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            const data = await res.json();
            document.getElementById("meOutput").innerText = JSON.stringify(data, null, 2);

        } catch (err) {
            alert("请求失败：" + err);
        }
    }
</script>

</body>
</html>